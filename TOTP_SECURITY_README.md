# TOTP动态口令安全功能说明

## 功能概述

本系统已集成TOTP（基于时间的一次性密码）双因素认证功能，为后台管理提供额外的安全保护。

## 主要特性

### 🔐 双因素认证
- 用户名密码 + 动态口令双重验证
- 即使密码泄露，账户仍然安全
- 支持标准TOTP协议

### 📱 扫码配置
- 自动生成二维码
- 支持Google Authenticator、Microsoft Authenticator等主流TOTP应用
- 一键扫描，快速配置

### 💾 设备记住功能
- 可选择"记住该设备"
- 30天内无需重复输入动态口令
- 自动生成设备令牌，安全可靠

### 🛡️ 安全防护
- 动态口令每30秒自动更新
- 支持时间窗口验证，容错性强
- 设备令牌加密存储

## 配置步骤

### 1. 启用TOTP
1. 访问 `/admin/totp` 页面
2. 点击"启用TOTP"按钮
3. 系统自动生成密钥和二维码

### 2. 配置TOTP应用
1. 在手机上安装TOTP应用（推荐：Google Authenticator、Microsoft Authenticator）
2. 扫描配置页面显示的二维码
3. 或手动输入密钥（如果无法扫描）

### 3. 测试验证
1. 在TOTP应用中查看生成的6位动态口令
2. 在配置页面输入动态口令进行测试
3. 确认配置正确后完成设置

## 使用方法

### 首次登录
1. 访问 `/admin/login` 页面
2. 输入用户名和密码
3. 系统检测到TOTP已启用，要求输入动态口令
4. 在TOTP应用中查看当前动态口令
5. 输入6位动态口令
6. 可选择"记住该设备"（推荐）
7. 点击"验证"完成登录

### 后续登录
- **未选择"记住该设备"**：每次都需要输入动态口令
- **已选择"记住该设备"**：30天内无需输入动态口令，自动验证设备令牌

### 登出
1. 在管理页面点击"🚪 登出"按钮
2. 系统自动清除设备令牌和cookie
3. 重定向到登录页面

## 支持的TOTP应用

### 移动端应用
- **Google Authenticator** (iOS/Android)
- **Microsoft Authenticator** (iOS/Android)
- **Authy** (iOS/Android)
- **1Password** (iOS/Android)
- **Bitwarden** (iOS/Android)

### 桌面端应用
- **KeePassXC** (Windows/macOS/Linux)
- **1Password** (Windows/macOS/Linux)
- **Bitwarden** (Windows/macOS/Linux)

## 安全建议

### 🔒 最佳实践
1. **启用TOTP**：强烈建议所有管理员账户启用TOTP
2. **使用官方应用**：选择知名厂商的TOTP应用
3. **备份密钥**：妥善保管TOTP密钥，避免设备丢失
4. **定期更新**：定期更换TOTP密钥
5. **设备管理**：及时清理不再使用的设备令牌

### ⚠️ 注意事项
1. **密钥安全**：不要将TOTP密钥分享给他人
2. **设备安全**：确保手机等设备的安全性
3. **网络环境**：在安全的网络环境下配置TOTP
4. **备份恢复**：准备密钥备份，防止设备故障

## 故障排除

### 常见问题

#### 1. 动态口令验证失败
- 检查TOTP应用时间是否准确
- 确认输入的6位数字正确
- 尝试重新扫描二维码配置

#### 2. 二维码无法扫描
- 确保二维码清晰可见
- 尝试手动输入密钥
- 检查TOTP应用是否支持二维码扫描

#### 3. 设备令牌失效
- 设备令牌可能已过期（30天）
- 重新登录并选择"记住该设备"
- 检查浏览器cookie设置

#### 4. 无法访问管理页面
- 检查是否已登录
- 清除浏览器cookie后重新登录
- 确认设备令牌是否有效

### 重置TOTP
如果遇到严重问题，可以：
1. 访问 `/admin/totp` 页面
2. 点击"禁用TOTP"按钮
3. 重新配置TOTP

## 技术实现

### 核心组件
- **TOTP生成**：使用speakeasy库生成标准TOTP
- **二维码生成**：使用qrcode库生成otpauth://格式的二维码
- **设备令牌**：基于时间戳和随机字符串生成唯一标识
- **Cookie管理**：使用httpOnly cookie存储设备令牌

### 安全机制
- **时间窗口验证**：支持±30秒的时间偏差
- **设备令牌加密**：存储在Redis中，支持过期时间
- **Cookie安全**：httpOnly、secure、sameSite等安全属性
- **中间件保护**：自动拦截未认证的管理路由访问

### 数据存储
- **开发环境**：使用内存存储（Map）
- **生产环境**：使用Redis存储
- **配置信息**：TOTP密钥、设备令牌等敏感数据

## 配置参数

### TOTP设置
- **算法**：SHA1（标准兼容性最好）
- **位数**：6位数字
- **周期**：30秒
- **密钥长度**：32字节（Base32编码）

### 设备令牌设置
- **有效期**：30天
- **格式**：`device_{timestamp}_{random}`
- **存储**：Redis + Cookie

## 更新日志

### v1.0.0 (2024-08-27)
- ✨ 初始版本发布
- 🔐 支持TOTP双因素认证
- 📱 支持二维码扫描配置
- 💾 支持设备记住功能
- 🛡️ 集成中间件路由保护
- 🚪 支持安全登出

## 联系支持

如果在使用过程中遇到问题，请：
1. 查看本文档的故障排除部分
2. 检查浏览器控制台的错误信息
3. 联系系统管理员获取支持

---

**注意**：TOTP功能是系统安全的重要组成部分，请谨慎配置和使用。




